<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title><%= title %> - المدرسة الإعدادية أبو القاسم الشابي</title>
  <link href="/css/output.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
  <%- include('../partials/navbar') %>
  
  <section class="min-h-screen bg-gray-100 py-8">
    <div class="container mx-auto px-4">
      <div class="max-w-3xl mx-auto">
        <!-- العودة -->
        <div class="mb-6">
          <a href="/teacher/dashboard" class="text-primary-600 hover:text-primary-800">
            <i class="fas fa-arrow-right ml-1"></i>
            العودة للوحة التحكم
          </a>
        </div>

        <!-- نموذج الإشعار -->
        <div class="bg-white rounded-lg shadow-md p-8">
          <h2 class="text-3xl font-bold text-gray-800 mb-2">
            <i class="fas fa-bell ml-2 text-primary-600"></i>
            إرسال إشعار للتلاميذ
          </h2>
          <p class="text-gray-600 mb-8">
            أرسل إشعاراً مهماً لجميع تلاميذ القسم المحدد
          </p>

          <%- include('../partials/messages') %>

          <form action="/teacher/send-notification" method="POST" id="notificationForm">
            <!-- نوع الإرسال -->
            <div class="mb-6">
              <label class="block text-gray-700 font-semibold mb-3">
                <i class="fas fa-paper-plane ml-2"></i>
                نوع الإرسال *
              </label>
              <div class="space-y-3">
                <label class="flex items-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                  <input type="radio" name="notificationType" value="class" class="ml-3 w-5 h-5 text-primary-600" checked onchange="toggleNotificationType()">
                  <div>
                    <div class="font-semibold text-gray-800">
                      <i class="fas fa-users ml-1 text-primary-600"></i>
                      إرسال لقسم كامل
                    </div>
                    <div class="text-sm text-gray-600">إرسال الإشعار لجميع تلاميذ قسم معين</div>
                  </div>
                </label>
                
                <label class="flex items-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                  <input type="radio" name="notificationType" value="section" class="ml-3 w-5 h-5 text-primary-600" onchange="toggleNotificationType()">
                  <div>
                    <div class="font-semibold text-gray-800">
                      <i class="fas fa-users ml-1 text-green-600"></i>
                      إرسال لصف معين من قسم
                    </div>
                    <div class="text-sm text-gray-600">إرسال الإشعار لجميع تلاميذ صف محدد من القسم</div>
                  </div>
                </label>
                
                <label class="flex items-center p-4 border-2 border-gray-300 rounded-lg cursor-pointer hover:border-primary-500 transition-colors">
                  <input type="radio" name="notificationType" value="specific" class="ml-3 w-5 h-5 text-primary-600" onchange="toggleNotificationType()">
                  <div>
                    <div class="font-semibold text-gray-800">
                      <i class="fas fa-user ml-1 text-blue-600"></i>
                      إرسال لتلميذ معين
                    </div>
                    <div class="text-sm text-gray-600">إرسال الإشعار لتلميذ واحد فقط</div>
                  </div>
                </label>
              </div>
            </div>

            <!-- المرحلة 1: اختيار القسم -->
            <div class="mb-6" id="classSelection">
              <label class="block text-gray-700 font-semibold mb-2" for="targetClass">
                <i class="fas fa-graduation-cap ml-2"></i>
                <span id="classLabel">القسم المستهدف *</span>
              </label>
              <select id="targetClass" name="targetClass" class="input-field" onchange="loadSections()">
                <option value="">اختر القسم</option>
                <option value="السابعة أساسي">السابعة أساسي</option>
                <option value="الثامنة أساسي">الثامنة أساسي</option>
                <option value="التاسعة أساسي">التاسعة أساسي</option>
              </select>
              <p class="text-sm text-gray-500 mt-1" id="classHint">
                اختر القسم أولاً
              </p>
            </div>

            <!-- المرحلة 2: اختيار الصف (يظهر فقط عند اختيار "صف معين" أو "تلميذ معين") -->
            <div class="mb-6 hidden" id="sectionSelection">
              <label class="block text-gray-700 font-semibold mb-2" for="targetSection">
                <i class="fas fa-users ml-2"></i>
                الصف المستهدف *
              </label>
              <select id="targetSection" name="targetSection" class="input-field" onchange="loadStudents()" disabled>
                <option value="">اختر الصف</option>
              </select>
              <p class="text-sm text-gray-500 mt-1">
                <i class="fas fa-info-circle ml-1"></i>
                اختر القسم أولاً لتحميل الصفوف المتاحة
              </p>
            </div>

            <!-- المرحلة 3: اختيار التلميذ (يظهر فقط عند اختيار "تلميذ معين") -->
            <div class="mb-6 hidden" id="studentSelection">
              <label class="block text-gray-700 font-semibold mb-2" for="specificStudent">
                <i class="fas fa-user-graduate ml-2"></i>
                اختر التلميذ *
              </label>
              <select id="specificStudent" name="specificStudent" class="input-field" disabled>
                <option value="">اختر التلميذ</option>
              </select>
              <p class="text-sm text-gray-500 mt-1">
                <i class="fas fa-info-circle ml-1"></i>
                اختر القسم والصف أولاً لتحميل قائمة التلاميذ
              </p>
            </div>

            <!-- عنوان الإشعار -->
            <div class="mb-6">
              <label class="block text-gray-700 font-semibold mb-2" for="title">
                <i class="fas fa-heading ml-2"></i>
                عنوان الإشعار *
              </label>
              <input 
                type="text" 
                id="title" 
                name="title" 
                class="input-field"
                required
                placeholder="مثال: إشعار مهم، درس جديد، تذكير بالواجب..."
                maxlength="100"
              >
            </div>

            <!-- نص الإشعار -->
            <div class="mb-6">
              <label class="block text-gray-700 font-semibold mb-2" for="message">
                <i class="fas fa-comment-dots ml-2"></i>
                نص الإشعار *
              </label>
              <textarea 
                id="message" 
                name="message" 
                class="input-field"
                rows="6"
                required
                placeholder="اكتب نص الإشعار هنا..."
                maxlength="500"
              ></textarea>
              <p class="text-sm text-gray-500 mt-1">
                الحد الأقصى: 500 حرف
              </p>
            </div>

            <!-- معاينة -->
            <div class="bg-blue-50 border-r-4 border-blue-500 rounded-lg p-4 mb-6">
              <h4 class="font-semibold text-blue-800 mb-2">
                <i class="fas fa-info-circle ml-1"></i>
                معاينة الإشعار
              </h4>
              <div class="bg-white rounded-lg p-4 mt-3">
                <div class="flex items-start space-x-reverse space-x-3">
                  <div class="flex-shrink-0">
                    <div class="w-10 h-10 bg-primary-100 rounded-full flex items-center justify-center">
                      <i class="fas fa-bell text-primary-600"></i>
                    </div>
                  </div>
                  <div class="flex-1">
                    <h5 class="font-bold text-gray-800 mb-1" id="preview-title">عنوان الإشعار</h5>
                    <p class="text-gray-600 text-sm" id="preview-message">نص الإشعار سيظهر هنا...</p>
                    <p class="text-xs text-gray-400 mt-2">
                      <i class="fas fa-user ml-1"></i>
                      من: <%= user.name %> (معلم <%= user.subject || '' %>)
                    </p>
                  </div>
                </div>
              </div>
            </div>

            <!-- ملاحظات هامة -->
            <div class="bg-yellow-50 border-r-4 border-yellow-500 rounded-lg p-4 mb-6">
              <h4 class="font-semibold text-yellow-800 mb-2">
                <i class="fas fa-exclamation-triangle ml-1"></i>
                ملاحظات هامة
              </h4>
              <ul class="text-sm text-gray-700 space-y-1" id="importantNotes">
                <li class="class-note"><i class="fas fa-check text-green-500 ml-1"></i> تأكد من اختيار القسم الصحيح</li>
                <li class="class-note"><i class="fas fa-check text-green-500 ml-1"></i> سيصل الإشعار لجميع تلاميذ القسم فوراً</li>
                <li class="section-note hidden"><i class="fas fa-check text-green-500 ml-1"></i> تأكد من اختيار القسم والصف الصحيحين</li>
                <li class="section-note hidden"><i class="fas fa-check text-green-500 ml-1"></i> سيصل الإشعار لجميع تلاميذ الصف المحدد فقط</li>
                <li class="student-note hidden"><i class="fas fa-check text-green-500 ml-1"></i> تأكد من اختيار التلميذ الصحيح</li>
                <li class="student-note hidden"><i class="fas fa-check text-green-500 ml-1"></i> سيصل الإشعار للتلميذ المحدد فقط</li>
                <li><i class="fas fa-check text-green-500 ml-1"></i> يمكن للتلاميذ مشاهدة الإشعار في صفحة الإشعارات</li>
                <li><i class="fas fa-check text-green-500 ml-1"></i> تأكد من وضوح ودقة نص الإشعار</li>
              </ul>
            </div>

            <!-- أزرار الإجراء -->
            <div class="flex justify-end space-x-reverse space-x-4">
              <a href="/teacher/dashboard" class="btn-secondary">
                إلغاء
              </a>
              <button type="submit" class="btn-primary">
                <i class="fas fa-paper-plane ml-2"></i>
                إرسال الإشعار
              </button>
            </div>
          </form>
        </div>

        <!-- نصائح -->
        <div class="bg-green-50 rounded-lg p-6 mt-6">
          <h3 class="font-bold text-green-800 mb-3">
            <i class="fas fa-lightbulb ml-2"></i>
            نصائح لإرسال إشعارات فعّالة
          </h3>
          <ul class="space-y-2 text-gray-700">
            <li class="flex items-start">
              <i class="fas fa-check-circle text-green-500 ml-2 mt-1"></i>
              <span>استخدم عناوين واضحة ومختصرة</span>
            </li>
            <li class="flex items-start">
              <i class="fas fa-check-circle text-green-500 ml-2 mt-1"></i>
              <span>اكتب نصاً مباشراً وسهل الفهم</span>
            </li>
            <li class="flex items-start">
              <i class="fas fa-check-circle text-green-500 ml-2 mt-1"></i>
              <span>حدد تاريخ أو موعد إذا كان الإشعار عن حدث معين</span>
            </li>
            <li class="flex items-start">
              <i class="fas fa-check-circle text-green-500 ml-2 mt-1"></i>
              <span>تجنب إرسال إشعارات غير ضرورية</span>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <%- include('../partials/footer') %>

  <script>
    // معاينة مباشرة للإشعار
    document.getElementById('title').addEventListener('input', function(e) {
      document.getElementById('preview-title').textContent = e.target.value || 'عنوان الإشعار';
    });

    document.getElementById('message').addEventListener('input', function(e) {
      document.getElementById('preview-message').textContent = e.target.value || 'نص الإشعار سيظهر هنا...';
    });

    // تبديل نوع الإرسال
    function toggleNotificationType() {
      const notificationType = document.querySelector('input[name="notificationType"]:checked').value;
      const classSelection = document.getElementById('classSelection');
      const sectionSelection = document.getElementById('sectionSelection');
      const studentSelection = document.getElementById('studentSelection');
      const targetClass = document.getElementById('targetClass');
      const targetSection = document.getElementById('targetSection');
      const specificStudent = document.getElementById('specificStudent');
      const classLabel = document.getElementById('classLabel');
      const classHint = document.getElementById('classHint');
      const classNotes = document.querySelectorAll('.class-note');
      const sectionNotes = document.querySelectorAll('.section-note');
      const studentNotes = document.querySelectorAll('.student-note');
      
      // إعادة تعيين جميع الحقول
      targetClass.value = '';
      targetSection.value = '';
      specificStudent.value = '';
      targetSection.disabled = true;
      specificStudent.disabled = true;
      targetSection.innerHTML = '<option value="">اختر الفصل</option>';
      specificStudent.innerHTML = '<option value="">اختر التلميذ</option>';
      
      // إخفاء جميع الملاحظات
      classNotes.forEach(note => note.classList.add('hidden'));
      sectionNotes.forEach(note => note.classList.add('hidden'));
      studentNotes.forEach(note => note.classList.add('hidden'));
      
      if (notificationType === 'class') {
        // إرسال لقسم كامل
        classSelection.classList.remove('hidden');
        sectionSelection.classList.add('hidden');
        studentSelection.classList.add('hidden');
        targetClass.required = true;
        targetSection.required = false;
        specificStudent.required = false;
        classLabel.textContent = 'القسم المستهدف *';
        classHint.innerHTML = 'سيتم إرسال الإشعار لجميع تلاميذ القسم المحدد';
        classNotes.forEach(note => note.classList.remove('hidden'));
      } else if (notificationType === 'section') {
        // إرسال لصف معين
        classSelection.classList.remove('hidden');
        sectionSelection.classList.remove('hidden');
        studentSelection.classList.add('hidden');
        targetClass.required = true;
        targetSection.required = true;
        specificStudent.required = false;
        classLabel.textContent = 'اختر القسم *';
        classHint.innerHTML = '<i class="fas fa-arrow-down ml-1 text-primary-600"></i> بعد اختيار القسم، اختر الصف المستهدف';
        sectionNotes.forEach(note => note.classList.remove('hidden'));
      } else {
        // إرسال لتلميذ معين
        classSelection.classList.remove('hidden');
        sectionSelection.classList.remove('hidden');
        studentSelection.classList.remove('hidden');
        targetClass.required = true;
        targetSection.required = true;
        specificStudent.required = true;
        classLabel.textContent = 'اختر القسم *';
        classHint.innerHTML = '<i class="fas fa-arrow-down ml-1 text-blue-600"></i> المرحلة 1 من 3: اختر القسم أولاً';
        studentNotes.forEach(note => note.classList.remove('hidden'));
      }
    }

    // تحميل الصفوف عند اختيار القسم
    async function loadSections() {
      const classLevel = document.getElementById('targetClass').value;
      const sectionSelect = document.getElementById('targetSection');
      const studentSelect = document.getElementById('specificStudent');
      const notificationType = document.querySelector('input[name="notificationType"]:checked').value;
      
      // إعادة تعيين الصفوف والتلاميذ
      sectionSelect.innerHTML = '<option value="">جاري التحميل...</option>';
      sectionSelect.disabled = true;
      studentSelect.innerHTML = '<option value="">اختر التلميذ</option>';
      studentSelect.disabled = true;
      
      if (!classLevel) {
        sectionSelect.innerHTML = '<option value="">اختر الصف</option>';
        return;
      }
      
      try {
        const response = await fetch(`/teacher/api/sections-by-class/${encodeURIComponent(classLevel)}`);
        const data = await response.json();
        
        if (data.sections && data.sections.length > 0) {
          sectionSelect.innerHTML = '<option value="">اختر الصف</option>';
          data.sections.forEach(section => {
            const option = document.createElement('option');
            option.value = section;
            option.textContent = `صف ${section}`;
            sectionSelect.appendChild(option);
          });
          sectionSelect.disabled = false;
          
          // تحديث التلميحات
          if (notificationType === 'section') {
            document.getElementById('classHint').innerHTML = '<i class="fas fa-check text-green-600 ml-1"></i> تم تحميل الصفوف - اختر الصف المستهدف';
          } else if (notificationType === 'specific') {
            document.getElementById('classHint').innerHTML = '<i class="fas fa-check text-green-600 ml-1"></i> المرحلة 1 مكتملة - الآن اختر الصف';
          }
        } else {
          sectionSelect.innerHTML = '<option value="">لا توجد صفوف متاحة</option>';
        }
      } catch (error) {
        console.error('خطأ في تحميل الصفوف:', error);
        sectionSelect.innerHTML = '<option value="">حدث خطأ في التحميل</option>';
      }
    }

    // تحميل التلاميذ عند اختيار الصف
    async function loadStudents() {
      const classLevel = document.getElementById('targetClass').value;
      const section = document.getElementById('targetSection').value;
      const studentSelect = document.getElementById('specificStudent');
      const notificationType = document.querySelector('input[name="notificationType"]:checked').value;
      
      studentSelect.innerHTML = '<option value="">جاري التحميل...</option>';
      studentSelect.disabled = true;
      
      if (!classLevel || !section) {
        studentSelect.innerHTML = '<option value="">اختر التلميذ</option>';
        return;
      }
      
      // تحديث التلميح للإرسال لصف معين
      if (notificationType === 'section') {
        document.getElementById('classHint').innerHTML = '<i class="fas fa-check-double text-green-600 ml-1"></i> تم اختيار القسم والصف - جاهز للإرسال';
      }
      
      // إذا كان نوع الإرسال "صف معين"، لا نحتاج تحميل التلاميذ
      if (notificationType !== 'specific') {
        return;
      }
      
      try {
        const response = await fetch(`/teacher/api/students-by-section/${encodeURIComponent(classLevel)}/${encodeURIComponent(section)}`);
        const data = await response.json();
        
        if (data.students && data.students.length > 0) {
          studentSelect.innerHTML = '<option value="">اختر التلميذ</option>';
          data.students.forEach(student => {
            const option = document.createElement('option');
            option.value = student.id;
            option.textContent = student.name;
            studentSelect.appendChild(option);
          });
          studentSelect.disabled = false;
          document.getElementById('classHint').innerHTML = '<i class="fas fa-check-double text-green-600 ml-1"></i> المرحلة 2 مكتملة - الآن اختر التلميذ';
        } else {
          studentSelect.innerHTML = '<option value="">لا يوجد تلاميذ في هذا الصف</option>';
        }
      } catch (error) {
        console.error('خطأ في تحميل التلاميذ:', error);
        studentSelect.innerHTML = '<option value="">حدث خطأ في التحميل</option>';
      }
    }

    // تحديث التلميح عند اختيار التلميذ
    document.getElementById('specificStudent').addEventListener('change', function() {
      if (this.value) {
        document.getElementById('classHint').innerHTML = '<i class="fas fa-check-circle text-green-600 ml-1"></i> جميع المراحل مكتملة - جاهز للإرسال';
      }
    });

    // تشغيل عند تحميل الصفحة
    document.addEventListener('DOMContentLoaded', function() {
      toggleNotificationType();
    });
  </script>
</body>
</html>
